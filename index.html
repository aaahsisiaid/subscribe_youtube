<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTubeマルチアカウント購読ツール</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #ff0000;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin: 10px;
      border-radius: 8px;
      padding: 10px;
    }
    #log {
      width: 90%;
      height: 160px;
      margin: 10px auto;
      background: rgba(255,255,255,0.05);
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      font-family: Consolas, monospace;
    }
    .accountTab {
      display: inline-block;
      margin: 5px;
      padding: 6px 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
      transition: background 0.2s;
    }
    .accountTab.active {
      background: #ff0000;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
  </style>
</head>
<body>
  <h1>🎬 YouTubeマルチアカウント購読ツール</h1>

  <div>
    <button id="loginBtn">Googleアカウント追加</button>
    <button id="listBtn">購読一覧を表示</button>
    <button id="subscribeBtn">指定チャンネル購読</button>
    <button id="unsubscribeBtn">指定チャンネル登録解除</button>
  </div>

  <textarea id="handleInput" placeholder="@handle1, @handle2"></textarea>
  <div id="log"></div>

  <div id="accountTabs"></div>

  <table id="channelTable" style="display:none;">
    <thead>
      <tr>
        <th>チャンネルアイコン</th>
        <th>名前</th>
        <th>ハンドル</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://apis.google.com/js/api.js" async defer onload="handleClientLoad()"></script>
  <script>
    const CLIENT_ID = "320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM";
    const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

    const logBox = document.getElementById("log");
    const log = (m) => {
      logBox.innerHTML += m + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
      console.log(m);
    };

    let accounts = []; // { name, email, profile, token, subs }
    let currentAccountIndex = 0;

    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"],
        scope: SCOPES,
      });
      log("✅ YouTube API 初期化完了");
    }

    // ログインボタン
    document.getElementById("loginBtn").onclick = async () => {
      const auth2 = gapi.auth2.getAuthInstance();
      const user = await auth2.signIn();
      const profile = user.getBasicProfile();
      const token = user.getAuthResponse().access_token;

      const acc = {
        name: profile.getName(),
        email: profile.getEmail(),
        profile: profile.getImageUrl(),
        token,
        subs: []
      };
      accounts.push(acc);
      log(`👤 ログイン: ${acc.name} (${acc.email})`);
      renderAccountTabs();
    };

    // ハンドル→チャンネルID取得
    async function getChannelIdFromHandle(handle) {
      try {
        const query = handle.startsWith("@") ? handle : "@" + handle;
        const res = await gapi.client.youtube.search.list({
          part: "snippet",
          q: query,
          type: "channel",
          maxResults: 1,
        });
        const item = res.result.items?.[0];
        if (!item) throw new Error("チャンネルが見つかりません");
        return item.snippet.channelId || item.id.channelId;
      } catch (e) {
        log("❌ handle取得エラー: " + (e.message || e));
        return null;
      }
    }

    // 購読する
    async function subscribeChannel(token, channelId) {
      const res = await fetch("https://www.googleapis.com/youtube/v3/subscriptions?part=snippet", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          snippet: { resourceId: { kind: "youtube#channel", channelId } },
        }),
      });
      return await res.json();
    }

    // 登録解除
    async function unsubscribeChannel(token, channelId) {
      const list = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=id&forChannelId=${channelId}&mine=true`, {
        headers: { "Authorization": "Bearer " + token },
      });
      const data = await list.json();
      if (!data.items?.length) return "未登録";
      const subId = data.items[0].id;
      await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?id=${subId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token },
      });
      return "解除成功";
    }

    // 一覧取得
    async function listSubscriptions(token) {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50`, {
        headers: { "Authorization": "Bearer " + token },
      });
      return await res.json();
    }

    // アカウントタブ描画
    function renderAccountTabs() {
      const tabDiv = document.getElementById("accountTabs");
      tabDiv.innerHTML = "";
      accounts.forEach((acc, i) => {
        const tab = document.createElement("div");
        tab.className = "accountTab" + (i === currentAccountIndex ? " active" : "");
        tab.innerHTML = `<img src="${acc.profile}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:5px;">${acc.name}`;
        tab.onclick = () => {
          currentAccountIndex = i;
          renderAccountTabs();
          showSubscriptions();
        };
        tabDiv.appendChild(tab);
      });
    }

    // 購読一覧を表示
    async function showSubscriptions() {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("⚠️ アカウントを選択してください");
      log(`📋 ${acc.name} の購読チャンネルを取得中...`);

      const table = document.getElementById("channelTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      table.style.display = "table";

      const subs = await listSubscriptions(acc.token);
      acc.subs = subs.items || [];

      for (const item of acc.subs) {
        const ch = item.snippet.resourceId.channelId;
        const title = item.snippet.title;
        const thumb = item.snippet.thumbnails?.default?.url;
        const handle = item.snippet.title;
        const row = `<tr><td><img src="${thumb}"></td><td>${title}</td><td>${handle}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      }
    }

    // 購読ボタン
    document.getElementById("subscribeBtn").onclick = async () => {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("⚠️ アカウントを選択してください");
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("⚠️ ハンドルを入力してください");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      log(`🚀 ${acc.name} で購読開始`);
      for (const handle of handles) {
        const id = await getChannelIdFromHandle(handle);
        if (!id) { log(`❌ ${handle} 見つからず`); continue; }
        await subscribeChannel(acc.token, id);
        log(`✅ ${acc.name}: @${handle} を購読`);
        await new Promise(r => setTimeout(r, 1000));
      }
      showSubscriptions();
    };

    // 解除ボタン
    document.getElementById("unsubscribeBtn").onclick = async () => {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("⚠️ アカウントを選択してください");
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("⚠️ ハンドルを入力してください");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      log(`🚮 ${acc.name} で解除開始`);
      for (const handle of handles) {
        const id = await getChannelIdFromHandle(handle);
        if (!id) { log(`❌ ${handle} 見つからず`); continue; }
        const res = await unsubscribeChannel(acc.token, id);
        log(`🧹 ${acc.name}: @${handle} → ${res}`);
        await new Promise(r => setTimeout(r, 1000));
      }
      showSubscriptions();
    };

    // 一覧表示ボタン
    document.getElementById("listBtn").onclick = showSubscriptions;
  </script>
</body>
</html>
