<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTubeãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆè³¼èª­ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #ff0000;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin: 10px;
      border-radius: 8px;
      padding: 10px;
    }
    #log {
      width: 90%;
      height: 160px;
      margin: 10px auto;
      background: rgba(255,255,255,0.05);
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      font-family: Consolas, monospace;
    }
    .accountTab {
      display: inline-block;
      margin: 5px;
      padding: 6px 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
      transition: background 0.2s;
    }
    .accountTab.active {
      background: #ff0000;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
  </style>
</head>
<body>
  <h1>ğŸ¬ YouTubeãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆè³¼èª­ãƒ„ãƒ¼ãƒ«</h1>

  <div>
    <button id="loginBtn">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ </button>
    <button id="listBtn">è³¼èª­ä¸€è¦§ã‚’è¡¨ç¤º</button>
    <button id="subscribeBtn">æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«è³¼èª­</button>
    <button id="unsubscribeBtn">æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²è§£é™¤</button>
  </div>

  <textarea id="handleInput" placeholder="@handle1, @handle2"></textarea>
  <div id="log"></div>

  <div id="accountTabs"></div>

  <table id="channelTable" style="display:none;">
    <thead>
      <tr>
        <th>ãƒãƒ£ãƒ³ãƒãƒ«ã‚¢ã‚¤ã‚³ãƒ³</th>
        <th>åå‰</th>
        <th>ãƒãƒ³ãƒ‰ãƒ«</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://apis.google.com/js/api.js" async defer onload="handleClientLoad()"></script>
  <script>
    const CLIENT_ID = "320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM";
    const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

    const logBox = document.getElementById("log");
    const log = (m) => {
      logBox.innerHTML += m + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
      console.log(m);
    };

    let accounts = []; // { name, email, profile, token, subs }
    let currentAccountIndex = 0;

    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"],
        scope: SCOPES,
      });
      log("âœ… YouTube API åˆæœŸåŒ–å®Œäº†");
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
    document.getElementById("loginBtn").onclick = async () => {
      const auth2 = gapi.auth2.getAuthInstance();
      const user = await auth2.signIn();
      const profile = user.getBasicProfile();
      const token = user.getAuthResponse().access_token;

      const acc = {
        name: profile.getName(),
        email: profile.getEmail(),
        profile: profile.getImageUrl(),
        token,
        subs: []
      };
      accounts.push(acc);
      log(`ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³: ${acc.name} (${acc.email})`);
      renderAccountTabs();
    };

    // ãƒãƒ³ãƒ‰ãƒ«â†’ãƒãƒ£ãƒ³ãƒãƒ«IDå–å¾—
    async function getChannelIdFromHandle(handle) {
      try {
        const query = handle.startsWith("@") ? handle : "@" + handle;
        const res = await gapi.client.youtube.search.list({
          part: "snippet",
          q: query,
          type: "channel",
          maxResults: 1,
        });
        const item = res.result.items?.[0];
        if (!item) throw new Error("ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return item.snippet.channelId || item.id.channelId;
      } catch (e) {
        log("âŒ handleå–å¾—ã‚¨ãƒ©ãƒ¼: " + (e.message || e));
        return null;
      }
    }

    // è³¼èª­ã™ã‚‹
    async function subscribeChannel(token, channelId) {
      const res = await fetch("https://www.googleapis.com/youtube/v3/subscriptions?part=snippet", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          snippet: { resourceId: { kind: "youtube#channel", channelId } },
        }),
      });
      return await res.json();
    }

    // ç™»éŒ²è§£é™¤
    async function unsubscribeChannel(token, channelId) {
      const list = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=id&forChannelId=${channelId}&mine=true`, {
        headers: { "Authorization": "Bearer " + token },
      });
      const data = await list.json();
      if (!data.items?.length) return "æœªç™»éŒ²";
      const subId = data.items[0].id;
      await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?id=${subId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token },
      });
      return "è§£é™¤æˆåŠŸ";
    }

    // ä¸€è¦§å–å¾—
    async function listSubscriptions(token) {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=50`, {
        headers: { "Authorization": "Bearer " + token },
      });
      return await res.json();
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¿ãƒ–æç”»
    function renderAccountTabs() {
      const tabDiv = document.getElementById("accountTabs");
      tabDiv.innerHTML = "";
      accounts.forEach((acc, i) => {
        const tab = document.createElement("div");
        tab.className = "accountTab" + (i === currentAccountIndex ? " active" : "");
        tab.innerHTML = `<img src="${acc.profile}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:5px;">${acc.name}`;
        tab.onclick = () => {
          currentAccountIndex = i;
          renderAccountTabs();
          showSubscriptions();
        };
        tabDiv.appendChild(tab);
      });
    }

    // è³¼èª­ä¸€è¦§ã‚’è¡¨ç¤º
    async function showSubscriptions() {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      log(`ğŸ“‹ ${acc.name} ã®è³¼èª­ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—ä¸­...`);

      const table = document.getElementById("channelTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      table.style.display = "table";

      const subs = await listSubscriptions(acc.token);
      acc.subs = subs.items || [];

      for (const item of acc.subs) {
        const ch = item.snippet.resourceId.channelId;
        const title = item.snippet.title;
        const thumb = item.snippet.thumbnails?.default?.url;
        const handle = item.snippet.title;
        const row = `<tr><td><img src="${thumb}"></td><td>${title}</td><td>${handle}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      }
    }

    // è³¼èª­ãƒœã‚¿ãƒ³
    document.getElementById("subscribeBtn").onclick = async () => {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("âš ï¸ ãƒãƒ³ãƒ‰ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      log(`ğŸš€ ${acc.name} ã§è³¼èª­é–‹å§‹`);
      for (const handle of handles) {
        const id = await getChannelIdFromHandle(handle);
        if (!id) { log(`âŒ ${handle} è¦‹ã¤ã‹ã‚‰ãš`); continue; }
        await subscribeChannel(acc.token, id);
        log(`âœ… ${acc.name}: @${handle} ã‚’è³¼èª­`);
        await new Promise(r => setTimeout(r, 1000));
      }
      showSubscriptions();
    };

    // è§£é™¤ãƒœã‚¿ãƒ³
    document.getElementById("unsubscribeBtn").onclick = async () => {
      const acc = accounts[currentAccountIndex];
      if (!acc) return log("âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("âš ï¸ ãƒãƒ³ãƒ‰ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      log(`ğŸš® ${acc.name} ã§è§£é™¤é–‹å§‹`);
      for (const handle of handles) {
        const id = await getChannelIdFromHandle(handle);
        if (!id) { log(`âŒ ${handle} è¦‹ã¤ã‹ã‚‰ãš`); continue; }
        const res = await unsubscribeChannel(acc.token, id);
        log(`ğŸ§¹ ${acc.name}: @${handle} â†’ ${res}`);
        await new Promise(r => setTimeout(r, 1000));
      }
      showSubscriptions();
    };

    // ä¸€è¦§è¡¨ç¤ºãƒœã‚¿ãƒ³
    document.getElementById("listBtn").onclick = showSubscriptions;
  </script>
</body>
</html>
