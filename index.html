<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTubeãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆè³¼èª­ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #ff0000;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    textarea {
      width: 90%;
      height: 100px;
      margin: 10px;
      border-radius: 8px;
      padding: 10px;
    }
    #log {
      width: 90%;
      height: 160px;
      margin: 10px auto;
      background: rgba(255,255,255,0.05);
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      font-family: Consolas, monospace;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: rgba(255,255,255,0.05);
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
  </style>
</head>
<body>
  <h1>ğŸ¬ YouTubeãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆè³¼èª­ãƒ„ãƒ¼ãƒ«</h1>

  <div>
    <button id="loginBtn">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ </button>
    <button id="listBtn">è³¼èª­ä¸€è¦§ã‚’è¡¨ç¤º</button>
    <button id="subscribeBtn">æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«è³¼èª­</button>
    <button id="unsubscribeBtn">æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²è§£é™¤</button>
  </div>

  <textarea id="handleInput" placeholder="@handle1, @handle2"></textarea>
  <div id="log"></div>

  <table id="channelTable" style="display:none;">
    <thead>
      <tr>
        <th>ãƒãƒ£ãƒ³ãƒãƒ«ã‚¢ã‚¤ã‚³ãƒ³</th>
        <th>åå‰</th>
        <th>ãƒãƒ³ãƒ‰ãƒ«</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://apis.google.com/js/api.js" async defer onload="handleClientLoad()"></script>
  <script>
    const CLIENT_ID = "320694642206-n0gk8vc7v6a3e2calbcp7r3jl50bic5p.apps.googleusercontent.com";
    const API_KEY = "AIzaSyCtUAPx02UxgEQtJzYcbRA1rJd5vi5AjaM";
    const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

    const logBox = document.getElementById("log");
    const log = (m) => { logBox.innerHTML += m + "<br>"; logBox.scrollTop = logBox.scrollHeight; console.log(m); };

    let accounts = []; // { name, profile, auth }

    function handleClientLoad() {
      gapi.load("client:auth2", initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"],
        scope: SCOPES,
      });
      log("âœ… YouTube API åˆæœŸåŒ–å®Œäº†");
    }

    // --- ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦åˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ  ---
    document.getElementById("loginBtn").onclick = async () => {
      const auth2 = gapi.auth2.getAuthInstance();
      const user = await auth2.signIn();
      const profile = user.getBasicProfile();
      const token = user.getAuthResponse().access_token;
      accounts.push({ 
        name: profile.getName(), 
        email: profile.getEmail(), 
        profile: profile.getImageUrl(), 
        token 
      });
      log(`ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³: ${profile.getName()} (${profile.getEmail()})`);
    };

    // --- ãƒãƒ³ãƒ‰ãƒ«â†’channelIdå–å¾— ---
    async function getChannelIdFromHandle(handle) {
      try {
        const res = await gapi.client.youtube.channels.list({
          part: "id",
          forHandle: handle.replace(/^@/, ""),
        });
        return res.result.items?.[0]?.id || null;
      } catch (e) {
        log("âŒ handleå–å¾—ã‚¨ãƒ©ãƒ¼: " + e.message);
        return null;
      }
    }

    // --- è³¼èª­å®Ÿè¡Œ ---
    async function subscribeChannel(token, channelId) {
      const res = await fetch("https://www.googleapis.com/youtube/v3/subscriptions?part=snippet", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          snippet: { resourceId: { kind: "youtube#channel", channelId } },
        }),
      });
      return await res.json();
    }

    // --- è³¼èª­è§£é™¤ ---
    async function unsubscribeChannel(token, channelId) {
      const list = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=id&forChannelId=${channelId}&mine=true`, {
        headers: { "Authorization": "Bearer " + token },
      });
      const data = await list.json();
      if (!data.items?.length) return "æœªç™»éŒ²";
      const subId = data.items[0].id;
      await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?id=${subId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token },
      });
      return "è§£é™¤æˆåŠŸ";
    }

    // --- è³¼èª­ä¸€è¦§å–å¾— ---
    async function listSubscriptions(token) {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&mine=true&maxResults=20`, {
        headers: { "Authorization": "Bearer " + token },
      });
      return await res.json();
    }

    // --- ç™»éŒ²ä¸€è¦§ã‚’è¡¨ã§è¡¨ç¤º ---
    async function showSubscriptions() {
      const table = document.getElementById("channelTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      table.style.display = "table";

      for (const acc of accounts) {
        log(`ğŸ“‹ ${acc.name} ã®è³¼èª­ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—ä¸­...`);
        const subs = await listSubscriptions(acc.token);
        for (const item of subs.items || []) {
          const ch = item.snippet.resourceId.channelId;
          const title = item.snippet.title;
          const thumb = item.snippet.thumbnails?.default?.url;
          const handle = item.snippet.title;
          const row = `<tr><td><img src="${thumb}"></td><td>${title}</td><td>${handle}</td></tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        }
      }
    }

    // --- è³¼èª­ãƒœã‚¿ãƒ³ ---
    document.getElementById("subscribeBtn").onclick = async () => {
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("âš ï¸ ãƒãƒ³ãƒ‰ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      for (const acc of accounts) {
        log(`ğŸš€ ${acc.name} ã§å‡¦ç†é–‹å§‹`);
        for (const handle of handles) {
          const id = await getChannelIdFromHandle(handle);
          if (!id) { log(`âŒ ${handle} è¦‹ã¤ã‹ã‚‰ãš`); continue; }
          const res = await subscribeChannel(acc.token, id);
          log(`âœ… ${acc.name}: ${handle} ã‚’è³¼èª­`);
          await new Promise(r => setTimeout(r, 1000)); // APIåˆ¶é™å¯¾ç­–
        }
      }
    };

    // --- è§£é™¤ãƒœã‚¿ãƒ³ ---
    document.getElementById("unsubscribeBtn").onclick = async () => {
      const raw = document.getElementById("handleInput").value.trim();
      if (!raw) return log("âš ï¸ ãƒãƒ³ãƒ‰ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const handles = raw.split(/[\n,]+/).map(h => h.trim().replace(/^@/, "")).filter(Boolean);

      for (const acc of accounts) {
        log(`ğŸš® ${acc.name} ã§è§£é™¤å‡¦ç†`);
        for (const handle of handles) {
          const id = await getChannelIdFromHandle(handle);
          if (!id) { log(`âŒ ${handle} è¦‹ã¤ã‹ã‚‰ãš`); continue; }
          const res = await unsubscribeChannel(acc.token, id);
          log(`ğŸ§¹ ${acc.name}: ${handle} â†’ ${res}`);
          await new Promise(r => setTimeout(r, 1000));
        }
      }
    };

    // --- ä¸€è¦§è¡¨ç¤ºãƒœã‚¿ãƒ³ ---
    document.getElementById("listBtn").onclick = showSubscriptions;
  </script>
</body>
</html>
